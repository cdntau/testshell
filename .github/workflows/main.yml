name: Upload Endpoint

on:
  workflow_dispatch:

jobs:
  upload-endpoint:
    runs-on: ubuntu-latest

    steps:
      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y nodejs npm

      - name: Create upload server
        run: |
          cat << 'EOF' > server.js
          const express = require("express");
          const multer = require("multer");
          const upload = multer({ dest: "uploads/" });

          const app = express();
          app.post("/upload", upload.single("file"), (req, res) => {
            console.log("Uploaded:", req.file.originalname, "->", req.file.path);
            res.send("OK");
          });

          app.get("/", (req, res) => res.send("Upload endpoint ready"));
          app.listen(3000, () => console.log("Server started on 3000"));
          EOF

          npm init -y
          npm install express multer

      - name: Start server
        run: |
          mkdir -p uploads
          node server.js &

      - name: Download Cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start public tunnel
        run: |
          echo "Creating public tunnel..."
          cloudflared tunnel --url http://localhost:3000 --no-autoupdate
